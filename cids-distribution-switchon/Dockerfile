FROM cismet/cids-distribution-cache:latest

MAINTAINER Pascal Dih√© <pascal.dihe@cismet.de>

LABEL de.cismet.cids.distribution.switchon.name="cids-distribution-switchon image" \
      de.cismet.cids.distribution.switchon.version="cidsDistributionSwitchon-1.0" \
      de.cismet.cids.distribution.switchon.descripton="cids SWITCH-ON Distribution Runtime Image"

ENV CIDS_ACCOUNT_EXTENSION="Switchon"
ENV CIDS_LOCAL_DIR ${CIDS_LIB_DIR}/local${CIDS_ACCOUNT_EXTENSION}
ENV CIDS_STARTER_DIR ${CIDS_LIB_DIR}/starter${CIDS_ACCOUNT_EXTENSION}

#EXPOSE 9986
#EXPOSE 8890
#EXPOSE 80

# use .dockerignore to control which files go into the image and which not (faster!)
# cache is used if settings.xml & POM.xml do not change
COPY cidsDistribution/ ${CIDS_DISTRIBUTION_DIR}/

# local libs are required during image build time -> copy from templates to lib/localSwitchon
# don't add cidsDistribution/lib/.local.templates to .dockerignore in order to make this work
COPY cidsDistribution/lib/.local.templates ${CIDS_LOCAL_DIR}/

# prepare dowloads all dependencies and uses the build cache
# this image inherits from cids-distribution-cache, so dependencies should be there already
RUN ${CIDS_DISTRIBUTION_DIR}/utils/prepare_autodistribution.sh

# clever signing of 'static' dependencies 
RUN ${CIDS_DISTRIBUTION_DIR}/utils/sign_all.sh

# enable debug logging during mvn build (optional, disabled by default)
#RUN sed -i -- "s/org.slf4j.simpleLogger.defaultLogLevel=info/org.slf4j.simpleLogger.defaultLogLevel=debug/g" ${MAVEN_HOME}/conf/logging/simplelogger.properties \
#    && sed -i -- "s/org.slf4j.simpleLogger.logFile=System.out/org.slf4j.simpleLogger.logFile=build.log/g" ${MAVEN_HOME}/conf/logging/simplelogger.properties

# selectively invalidate build cache *after* this instruction if 'expire_after' build arg is provided (see build.sh)
ARG expire_after=never

# build the autodistribution using the *cached* and signed dependencies downloaded in prepare_autodistribution.sh step
# update snapshots and spossibly add new unsigned dependencies to lib/m2
RUN ${CIDS_DISTRIBUTION_DIR}/utils/build_autodistribution.sh

# brute force signing of new snapshot dependencies
# RUN ${CIDS_DISTRIBUTION_DIR}/utils/sign_all.sh

# copy generated client jnlp to lib/start dir and generate security.jar-> required since host mounted 
# volume overlays client directory (default target for client JNLPs generated by cids-java-maven plugin)
#RUN mkdir -p ${CIDS_CLIENT_DIR} \
#    && find ${CIDS_CLIENT_DIR} -name "*.jnlp" -type f -execdir ${CIDS_DISTRIBUTION_DIR}/utils/create_security_jar.sh {} \;

# WARNING: private data is still present in intermediate image layers! Don't push the image to public registries!
# See https://github.com/docker/docker/issues/13490
#--RUN rm -rf ${CIDS_DISTRIBUTION_DIR}/.private
RUN rm -rf ${CIDS_DISTRIBUTION_DIR}/lib/.local.templates
#RUN rm -rf ${CIDS_GENERATOR_DIR}

# add /tmp as volume since it may contain data that changes often 
VOLUME /tmp